name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add servers to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.SQL_DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh root@${{ secrets.DROPLET_IP }} << 'EOF'
          
          # Create application directory
          mkdir -p /var/www/rentall-cars
          cd /var/www/rentall-cars
          
          # Stop existing services if running
          pm2 delete all || true
          
          # Backup current deployment (if exists)
          if [ -d "current" ]; then
            rm -rf backup
            mv current backup
          fi
          
          # Clone/update repository
          if [ -d "repo" ]; then
            cd repo
            git fetch origin
            git reset --hard origin/main
            git pull origin main
          else
            git clone https://github.com/${{ github.repository }}.git repo
            cd repo
          fi
          
          # Create new deployment directory
          cd ..
          cp -r repo current
          cd current
          
          # Verify files are present
          echo "Files in current directory:"
          ls -la
          echo "Backend directory:"
          ls -la RentALL_Cars_API_V3.1.5/ || echo "Backend directory not found"
          echo "Frontend directory:"
          ls -la RentALL_Cars_V3.1.5/ || echo "Frontend directory not found"
          
          EOF

      - name: Setup MySQL Database
        run: |
          ssh root@${{ secrets.SQL_DROPLET_IP }} << 'EOF'
          
          # Install MySQL if not present
          sudo apt-get update
          sudo apt-get install -y mysql-server
          
          # Start MySQL service
          sudo systemctl start mysql
          sudo systemctl enable mysql
          
          # Secure MySQL installation (basic setup)
          sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${{ secrets.DATABASE_PASSWORD }}';" || true
          sudo mysql -e "FLUSH PRIVILEGES;"
          
          # Create database and user with mysql_native_password authentication
          sudo mysql -uroot -p${{ secrets.DATABASE_PASSWORD }} << MYSQLEOF || true
          DROP DATABASE IF EXISTS ${{ secrets.DATABASE_DBNAME }};
          CREATE DATABASE ${{ secrets.DATABASE_DBNAME }};
          DROP USER IF EXISTS '${{ secrets.DATABASE_USERNAME }}'@'%';
          DROP USER IF EXISTS '${{ secrets.DATABASE_USERNAME }}'@'localhost';
          
          -- Create user with mysql_native_password authentication
          CREATE USER '${{ secrets.DATABASE_USERNAME }}'@'%' IDENTIFIED WITH mysql_native_password BY '${{ secrets.DATABASE_PASSWORD }}';
          CREATE USER '${{ secrets.DATABASE_USERNAME }}'@'localhost' IDENTIFIED WITH mysql_native_password BY '${{ secrets.DATABASE_PASSWORD }}';
          
          -- Grant privileges
          GRANT ALL PRIVILEGES ON ${{ secrets.DATABASE_DBNAME }}.* TO '${{ secrets.DATABASE_USERNAME }}'@'%';
          GRANT ALL PRIVILEGES ON ${{ secrets.DATABASE_DBNAME }}.* TO '${{ secrets.DATABASE_USERNAME }}'@'localhost';
          
          -- Set default authentication plugin globally
          SET GLOBAL default_authentication_plugin = 'mysql_native_password';
          
          FLUSH PRIVILEGES;
          MYSQLEOF
          
          # Update MySQL configuration to use legacy authentication by default
          echo "[mysqld]" | sudo tee -a /etc/mysql/mysql.conf.d/mysqld.cnf
          echo "default_authentication_plugin=mysql_native_password" | sudo tee -a /etc/mysql/mysql.conf.d/mysqld.cnf
          
          # Allow remote connections
          sudo sed -i 's/bind-address\s*=\s*127.0.0.1/bind-address = 0.0.0.0/' /etc/mysql/mysql.conf.d/mysqld.cnf || true
          
          # Restart MySQL to apply changes
          sudo systemctl restart mysql
          
          # Open MySQL port in firewall
          sudo ufw allow 3306
          
          # Verify the user authentication method
          sudo mysql -uroot -p${{ secrets.DATABASE_PASSWORD }} -e "SELECT user, host, plugin FROM mysql.user WHERE user = '${{ secrets.DATABASE_USERNAME }}';"
          
          EOF

      - name: Import Database Dump
        run: |
          # Check if database dump exists
          if [ -f "./RentALL_Cars_V3.1.5/db/db_dump.sql" ]; then
            echo "Database dump found, copying to SQL droplet..."
            scp ./RentALL_Cars_V3.1.5/db/db_dump.sql root@${{ secrets.SQL_DROPLET_IP }}:/tmp/
            
            # Import the database dump
            ssh root@${{ secrets.SQL_DROPLET_IP }} << 'EOF'
            
            # Import database dump
            mysql -u${{ secrets.DATABASE_USERNAME }} -p${{ secrets.DATABASE_PASSWORD }} ${{ secrets.DATABASE_DBNAME }} < /tmp/db_dump.sql
            
            # Clean up dump file
            rm /tmp/db_dump.sql
            
            echo "Database import completed successfully!"
            
          EOF
          else
            echo "Database dump not found, skipping import..."
          fi

      - name: Setup System Dependencies
        run: |
          ssh root@${{ secrets.DROPLET_IP }} << 'EOF'
          
          # Update system packages
          sudo apt-get update
          
          # Install Node.js if not present
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # Install yarn and pm2 globally
          npm install -g yarn pm2
          
          # Install Nginx if not present
          sudo apt-get install -y nginx
          
          # Create swap file for build process (if not exists)
          if [ ! -f /swapfile ]; then
            sudo fallocate -l 2G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
          fi
          
          EOF

      - name: Setup Backend
        run: |
          ssh root@${{ secrets.DROPLET_IP }} << 'EOF'
          cd /var/www/rentall-cars/current/RentALL_Cars_API_V3.1.5
          
          echo "Setting up backend..."
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          
          # Install all dependencies (including dev dependencies for build)
          echo "Installing backend dependencies..."
          yarn install 
          
          # Update MySQL-related packages to support newer authentication
          echo "Updating MySQL packages for authentication compatibility..."
          yarn add mysql2@latest sequelize@latest || true
          
          # Create environment file
          cat > .env << 'ENVEOF'
          NODE_ENV=production
          PORT=4000
          DATABASE_URL=mysql://${{ secrets.DATABASE_USERNAME }}:${{ secrets.DATABASE_PASSWORD }}@${{ secrets.SQL_DROPLET_IP }}:3306/${{ secrets.DATABASE_DBNAME }}?authPlugin=mysql_native_password
          DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
          DATABASE_DBNAME=${{ secrets.DATABASE_DBNAME }}
          DATABASE_HOST=${{ secrets.SQL_DROPLET_IP }}
          DATABASE_DIALECT=mysql
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          WEBSITE_HOSTNAME=${{ secrets.DROPLET_IP }}:4000
          SITE_URL=http://${{ secrets.DROPLET_IP }}:3000
          SITENAME=${{ secrets.SITENAME }}
          WEBSITE_URL=http://${{ secrets.DROPLET_IP }}:3000
          SOCKET_PORT=4001
          SOCKET_URL=http://${{ secrets.DROPLET_IP }}:4001
          STRIPE_SECRET=${{ secrets.STRIPE_SECRET }}
          PAYPAL_RETURN_URL=${{ secrets.PAYPAL_RETURN_URL }}
          PAYPAL_CANCEL_URL=${{ secrets.PAYPAL_CANCEL_URL }}
          PAYPAL_SUCCESS_REDIRECT_URL=${{ secrets.PAYPAL_SUCCESS_REDIRECT_URL }}
          COINBASE_URL=${{ secrets.COINBASE_URL }}
          PLACE_DETAILS_URL=${{ secrets.PLACE_DETAILS_URL }}
          PLACES_AUTOCOMPLETE_URL=${{ secrets.PLACES_AUTOCOMPLETE_URL }}
          GOOGLE_MAP_SERVER_API=${{ secrets.GOOGLE_MAP_SERVER_API }}
          CRON_TIMEZONE=${{ secrets.CRON_TIMEZONE }}
          FILEUPLOAD_DIR=./images/upload/
          BANNER_UPLOAD_DIR=./images/banner/
          PROFILE_PHOTO_UPLOAD_DIR=./images/avatar/
          DOCUMENT_UPLOAD_DIR=./images/document/
          LOCATION_UPLOAD_DIR=./images/popularLocation/
          HOME_BANNER_UPLOAD_DIR=./images/home/
          CLAIM_IMAGES_UPLOAD_DIR=./images/claims/
          FAVICON_UPLOAD_DIR=./images/favicon/
          WHYHOST_UPLOAD_DIR=./images/whyhost/
          LOGOUPLOAD_DIR=./images/logo/
          OGIMAGEUPLOAD_DIR=./images/og-image/
          ENVEOF
          
          # Check available memory before build
          echo "Memory status before backend build:"
          free -h
          
          # Build the backend application
          echo "Building backend application..."
          NODE_OPTIONS="--max_old_space_size=2048" yarn run build --verbose 2>&1 | tee backend-build.log || {
            echo "Backend build failed, checking logs:"
            tail -50 backend-build.log
            echo "Memory status after failure:"
            free -h
            exit 1
          }
          
          # Create necessary directories
          mkdir -p images/upload images/banner images/avatar images/document
          mkdir -p images/popularLocation images/home images/claims
          mkdir -p images/favicon images/whyhost images/logo images/og-image
          
          # Set permissions
          chmod -R 755 images/
          
          # Remove dev dependencies after build
          echo "Removing dev dependencies..."
          yarn install --production --ignore-scripts
          
          echo "Backend setup completed"
          
          EOF

      - name: Setup Frontend
        run: |
          ssh root@${{ secrets.DROPLET_IP }} << 'EOF'
          cd /var/www/rentall-cars/current/RentALL_Cars_V3.1.5
          
          echo "Setting up frontend..."
          echo "Current directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          
          # Install dependencies first
          echo "Installing frontend dependencies..."
          yarn install 
          
          # Create environment file
          cat > .env << 'ENVEOF'
          NODE_ENV=production
          REACT_APP_API_URL=http://${{ secrets.DROPLET_IP }}:4000
          REACT_APP_SOCKET_URL=http://${{ secrets.DROPLET_IP }}:4001
          REACT_APP_NODE_ENV=production
          REACT_APP_JWT_SECRET=${{ secrets.JWT_SECRET }}
          REACT_APP_STRIPE_SECRET=${{ secrets.STRIPE_SECRET }}
          REACT_APP_GOOGLE_MAP_API=${{ secrets.GOOGLE_MAP_CLIENT_API }}
          DATABASE_URL=mysql://${{ secrets.DATABASE_USERNAME }}:${{ secrets.DATABASE_PASSWORD }}@${{ secrets.SQL_DROPLET_IP }}:3306/${{ secrets.DATABASE_DBNAME }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          COINBASE_URL=${{ secrets.COINBASE_URL }}
          PLACE_DETAILS_URL=${{ secrets.PLACE_DETAILS_URL }}
          PLACES_AUTOCOMPLETE_URL=${{ secrets.PLACES_AUTOCOMPLETE_URL }}
          PAYPAL_RETURN_URL=${{ secrets.PAYPAL_RETURN_URL }}
          PAYPAL_CANCEL_URL=${{ secrets.PAYPAL_CANCEL_URL }}
          PAYPAL_SUCCESS_REDIRECT_URL=${{ secrets.PAYPAL_SUCCESS_REDIRECT_URL }}
          STRIPE_SECRET=${{ secrets.STRIPE_SECRET }}
          GOOGLE_MAP_SERVER_API=${{ secrets.GOOGLE_MAP_SERVER_API }}
          CRON_TIMEZONE=${{ secrets.CRON_TIMEZONE }}
          FILEUPLOAD_DIR=./images/upload/
          BANNER_UPLOAD_DIR=./images/banner/
          PROFILE_PHOTO_UPLOAD_DIR=./images/avatar/
          DOCUMENT_UPLOAD_DIR=./images/document/
          LOCATION_UPLOAD_DIR=./images/popularLocation/
          HOME_BANNER_UPLOAD_DIR=./images/home/
          CLAIM_IMAGES_UPLOAD_DIR=./images/claims/
          FAVICON_UPLOAD_DIR=./images/favicon/
          WHYHOST_UPLOAD_DIR=./images/whyhost/
          LOGOUPLOAD_DIR=./images/logo/
          OGIMAGEUPLOAD_DIR=./images/og-image/
          API_URL=http://localhost:4000
          SOCKET_URL=http://localhost:4001
          SOCKET_PORT=4001
          SERVER_API_URL=http://localhost:4000
          ENVEOF
          
          # Check available memory before build
          echo "Memory status before frontend build:"
          free -h
          
          # Build the application with increased memory and verbose output
          echo "Starting frontend build..."
          yarn run build --verbose 2>&1 | tee frontend-build.log || {
            echo "Frontend build failed, checking logs:"
            tail -50 frontend-build.log
            echo "Memory status after failure:"
            free -h
            exit 1
          }
          
          # Create necessary directories
          mkdir -p images/upload images/banner images/avatar images/document
          mkdir -p images/popularLocation images/home images/claims
          mkdir -p images/favicon images/whyhost images/logo images/og-image
          
          # Set permissions
          chmod -R 755 images/
          
          echo "Frontend setup completed"
          
          EOF

      - name: Setup Nginx
        run: |
          ssh root@${{ secrets.DROPLET_IP }} << 'EOF'
          
          # Create Nginx configuration
          sudo tee /etc/nginx/sites-available/rentall-cars << 'NGINXEOF'
          server {
              listen 80;
              server_name ${{ secrets.DROPLET_IP }};
          
              # Frontend
              location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
          
              # Backend API
              location /api {
                  proxy_pass http://localhost:4000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
          
              # Socket.io
              location /socket.io {
                  proxy_pass http://localhost:4001;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          NGINXEOF
          
          # Enable the site
          sudo ln -sf /etc/nginx/sites-available/rentall-cars /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # Test and reload Nginx
          sudo nginx -t
          sudo systemctl reload nginx
          sudo systemctl enable nginx
          
          EOF

      - name: Setup PM2 Services
        run: |
          ssh root@${{ secrets.DROPLET_IP }} << 'EOF'
          cd /var/www/rentall-cars/current
          
          # Create PM2 ecosystem file
          cat > ecosystem.config.js << 'PMEOF'
          module.exports = {
            apps: [
              {
                name: 'rentall-backend',
                cwd: '/var/www/rentall-cars/current/RentALL_Cars_API_V3.1.5',
                script: 'yarn',
                args: 'start:production',
                env: {
                  NODE_ENV: 'production',
                  PORT: 4000
                },
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                error_file: '/var/log/pm2/rentall-backend-error.log',
                out_file: '/var/log/pm2/rentall-backend-out.log',
                log_file: '/var/log/pm2/rentall-backend.log'
              },
              {
                name: 'rentall-frontend',
                cwd: '/var/www/rentall-cars/current/RentALL_Cars_V3.1.5',
                script: 'yarn',
                args: 'start',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                },
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                error_file: '/var/log/pm2/rentall-frontend-error.log',
                out_file: '/var/log/pm2/rentall-frontend-out.log',
                log_file: '/var/log/pm2/rentall-frontend.log'
              }
            ]
          };
          PMEOF
          
          # Create log directory
          sudo mkdir -p /var/log/pm2
          
          # Start services with PM2
          pm2 delete all || true
          pm2 start ecosystem.config.js
          pm2 save
          pm2 startup systemd -u root --hp /root
          
          # Check PM2 status
          pm2 status
          pm2 logs --lines 50
          
          EOF

      - name: Health Check and Debugging
        run: |
          sleep 30
          
          ssh root@${{ secrets.DROPLET_IP }} << 'EOF'
          
          echo "=== DEPLOYMENT VERIFICATION ==="
          echo "Files in /var/www/rentall-cars:"
          ls -la /var/www/rentall-cars/
          
          echo "Files in current deployment:"
          ls -la /var/www/rentall-cars/current/
          
          echo "Backend build output:"
          ls -la /var/www/rentall-cars/current/RentALL_Cars_API_V3.1.5/build/ || echo "No backend build directory found"
          
          echo "Frontend build output:"
          ls -la /var/www/rentall-cars/current/RentALL_Cars_V3.1.5/build/ || echo "No frontend build directory found"
          
          echo "PM2 Process Status:"
          pm2 status
          
          echo "PM2 Logs (last 20 lines):"
          pm2 logs --lines 20
          
          echo "Nginx Status:"
          sudo systemctl status nginx --no-pager
          
          echo "Port Status:"
          sudo netstat -tlnp | grep -E ':3000|:4000|:4001|:80'
          
          EOF
          
          # External health checks
          echo "=== EXTERNAL HEALTH CHECKS ==="
          
          echo "Checking backend health..."
          curl -f http://${{ secrets.DROPLET_IP }}:4000 || echo "Backend direct access failed"
          
          echo "Checking frontend health..."
          curl -f http://${{ secrets.DROPLET_IP }}:3000 || echo "Frontend direct access failed"
          
          echo "Checking via Nginx..."
          curl -f http://${{ secrets.DROPLET_IP }} || echo "Nginx proxy check failed"
          
          echo "Checking database connection..."
          ssh root@${{ secrets.SQL_DROPLET_IP }} "mysql -u${{ secrets.DATABASE_USERNAME }} -p${{ secrets.DATABASE_PASSWORD }} -e 'SHOW DATABASES;'" || echo "Database connection check failed"

      - name: Cleanup old deployments
        run: |
          ssh root@${{ secrets.DROPLET_IP }} << 'EOF'
          cd /var/www/rentall-cars
          
          # Keep only current and backup
          rm -rf old_backup
          if [ -d "backup" ]; then
            mv backup old_backup
          fi
          
          # Clean up old PM2 logs
          pm2 flush
          
          echo "=== DEPLOYMENT COMPLETED SUCCESSFULLY ==="
          echo "Application should be available at: http://${{ secrets.DROPLET_IP }}"
          echo "Backend API: http://${{ secrets.DROPLET_IP }}:4000"
          echo "Frontend: http://${{ secrets.DROPLET_IP }}:3000"
          
          EOF